#user       www www;  ## Default: nobody
worker_processes  5;  ## Default: 1
error_log  /var/log/error.log;
pid        /var/log/nginx.pid;
worker_rlimit_nofile 8192;

events {
  worker_connections  4096;  ## Default: 1024
}

http {
  include    /etc/conf/mime.types;
#  include    /etc/conf/proxy.conf;
  include    /etc/conf/fastcgi.conf;
  index    index.html index.htm index.php;

  default_type application/octet-stream;
  log_format   main '$remote_addr - $remote_user [$time_local]  $status '
    '"$request" $body_bytes_sent "$http_referer" '
    '"$http_user_agent" "$http_x_forwarded_for"';
  access_log   /var/log/access.log  main;
  sendfile     on;
  tcp_nopush   on;
  server_names_hash_bucket_size 128; # this seems to be required for some vhosts

  upstream api {
    server win-ra-api:8282;
  }

  server { # 
    listen       443 ssl;
    server_name  winra.winllc-dev.com;
    access_log   /var/log/winllc-dev.access.log  main;

    ssl_certificate /etc/ssl/certificate.crt;
    ssl_certificate_key /etc/ssl/privateKey.key;
	
    # serve static files
    #location ~ ^/(images|javascript|js|css|flash|media|static)/  {
    #  root    /var/www/virtual/big.server.com/htdocs;
    #  expires 30d;
    #}


    # pass requests for dynamic content to rails/turbogears/zope, et al
    location /auth {
      proxy_pass      http://keycloak:8080;

      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $remote_addr;
      proxy_set_header X-Forwarded-Proto https;
      proxy_set_header X-Forwarded-Port 443;
      proxy_set_header ssl-client-cert $ssl_client_escaped_cert;

      proxy_buffer_size 64k;
      proxy_buffers 8 64k;
      proxy_busy_buffers_size 64k;	  
    }

    location /acme {
      proxy_pass      http://win-ra-acme:8181;

    }

    location /api {
      proxy_pass      http://win-ra-api:8282;
      proxy_redirect     off;
      proxy_set_header   Host $host;
      proxy_set_header   X-Real-IP $remote_addr;
      proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header   X-Forwarded-Host $server_name;
    }

    location /ui {
      proxy_pass      http://win-ra-ui:8484;

    }

   location /est {
      proxy_pass      http://win-ra-est:8383;

    }

  }

  #upstream big_server_com {
  #  server 127.0.0.3:8000 weight=5;
  #  server 127.0.0.3:8001 weight=5;
  #  server 192.168.0.1:8000;
  #  server 192.168.0.1:8001;
  #}

  #server { # simple load balancing
  #  listen          80;
  #  server_name     big.server.com;
  #  access_log      logs/big.server.access.log main;

  #  location / {
  #    proxy_pass      http://big_server_com;
  #  }
  #}
}
